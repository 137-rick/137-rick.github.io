<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>epoll和select | 徐艺洲</title>
<meta name="generator" content="Jekyll v3.7.4" />
<meta property="og:title" content="epoll和select" />
<meta name="author" content="徐艺洲" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="转载的，感觉不错，所以留下备份 来自于：http://m.cnblogs.com/62707/1681172.html epoll是Kernel 2.6后新加入的事件机制，在高并发条件下，远优于select. 用个硬件中的例子吧，可能不太恰当：epoll相当于I／O中断（有的时候才相应），而select相当于轮询（总要反复查询）。 其实epoll比slect好用很多， 主要一下几个用法。 struct epoll_event ;epoll事件体，事件发生时候你可以得到一个它。其中epoll_event.data.fd可以存储关联的句柄，epoll_event.event是监听标志，常用的有EPOLLIN （有数据，可以读）、EPOLLOUT（有数据，可以写）EPOLLET（有事件，通用）; （1） 创建epoll句柄 int epFd = epoll_create(EPOLL_SIZE); （2）加入一个句柄到 epoll的监听队列 ev.data.fd = serverFd;ev.events = EPOLLIN | EPOLLET;epoll_ctl(epFd, EPOLL_CTL_ADD, serverFd, &amp;ev); 上 面的fd是你要绑定给事件发生时候使用的fd,到时候只能操作这个，下面是事件类型。 使用epoll_ctl添加到之中，EPOLL_CTL_ADD是epoll控制类型，这里监听的fd和给event的fd一般相同。 (3)等待event返回 int nfds = epoll_wait(epFd, evs, EVENT_ARR, -1); 传入的evs是epoll_event的数组，EVENT_ARR应当是不超过这个数组的长度。返回nfds的是不超过EVENT_ARR的数值，表示本次等待到了几个事件。 (4)遍历事件 注意，这里遍历的事件是肯定已经发生了的，而select中遍历的是每个fd，而fd不一定在FDSET中（即不一定有读事件发生）！这是效率最大的差别所在！ for (int i = 0; i &lt; nfds; i++) { //do something } (5)其他技巧 对事件是否是 serverFd判断，如果是，进行accept并加入epoll监听队列，要设置异步读取。 如果evts[i]&amp;EPOLLIN，表示可读，使用read进行试探，如果&gt;0表示连接没有关闭，否则连接已经关闭（出发事件又读取不到东西，表示socket关闭！）。如果&lt;0出错。如果&gt;0，需要继续读取直到为0，但是注意这里的为0是在第一次read不为0的前提下，毕竟我们设置了异步读取，暂时没有数据可以读就返回0了！而如果第一次返回0，那么就是关闭吧！ 注意关闭要移出出epoll并且 close(clientFd) 罗嗦了好多，看代码！ 1" />
<meta property="og:description" content="转载的，感觉不错，所以留下备份 来自于：http://m.cnblogs.com/62707/1681172.html epoll是Kernel 2.6后新加入的事件机制，在高并发条件下，远优于select. 用个硬件中的例子吧，可能不太恰当：epoll相当于I／O中断（有的时候才相应），而select相当于轮询（总要反复查询）。 其实epoll比slect好用很多， 主要一下几个用法。 struct epoll_event ;epoll事件体，事件发生时候你可以得到一个它。其中epoll_event.data.fd可以存储关联的句柄，epoll_event.event是监听标志，常用的有EPOLLIN （有数据，可以读）、EPOLLOUT（有数据，可以写）EPOLLET（有事件，通用）; （1） 创建epoll句柄 int epFd = epoll_create(EPOLL_SIZE); （2）加入一个句柄到 epoll的监听队列 ev.data.fd = serverFd;ev.events = EPOLLIN | EPOLLET;epoll_ctl(epFd, EPOLL_CTL_ADD, serverFd, &amp;ev); 上 面的fd是你要绑定给事件发生时候使用的fd,到时候只能操作这个，下面是事件类型。 使用epoll_ctl添加到之中，EPOLL_CTL_ADD是epoll控制类型，这里监听的fd和给event的fd一般相同。 (3)等待event返回 int nfds = epoll_wait(epFd, evs, EVENT_ARR, -1); 传入的evs是epoll_event的数组，EVENT_ARR应当是不超过这个数组的长度。返回nfds的是不超过EVENT_ARR的数值，表示本次等待到了几个事件。 (4)遍历事件 注意，这里遍历的事件是肯定已经发生了的，而select中遍历的是每个fd，而fd不一定在FDSET中（即不一定有读事件发生）！这是效率最大的差别所在！ for (int i = 0; i &lt; nfds; i++) { //do something } (5)其他技巧 对事件是否是 serverFd判断，如果是，进行accept并加入epoll监听队列，要设置异步读取。 如果evts[i]&amp;EPOLLIN，表示可读，使用read进行试探，如果&gt;0表示连接没有关闭，否则连接已经关闭（出发事件又读取不到东西，表示socket关闭！）。如果&lt;0出错。如果&gt;0，需要继续读取直到为0，但是注意这里的为0是在第一次read不为0的前提下，毕竟我们设置了异步读取，暂时没有数据可以读就返回0了！而如果第一次返回0，那么就是关闭吧！ 注意关闭要移出出epoll并且 close(clientFd) 罗嗦了好多，看代码！ 1" />
<link rel="canonical" href="http://localhost:4000/archives/101" />
<meta property="og:url" content="http://localhost:4000/archives/101" />
<meta property="og:site_name" content="徐艺洲" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2010-04-29T13:04:49+08:00" />
<script type="application/ld+json">
{"description":"转载的，感觉不错，所以留下备份 来自于：http://m.cnblogs.com/62707/1681172.html epoll是Kernel 2.6后新加入的事件机制，在高并发条件下，远优于select. 用个硬件中的例子吧，可能不太恰当：epoll相当于I／O中断（有的时候才相应），而select相当于轮询（总要反复查询）。 其实epoll比slect好用很多， 主要一下几个用法。 struct epoll_event ;epoll事件体，事件发生时候你可以得到一个它。其中epoll_event.data.fd可以存储关联的句柄，epoll_event.event是监听标志，常用的有EPOLLIN （有数据，可以读）、EPOLLOUT（有数据，可以写）EPOLLET（有事件，通用）; （1） 创建epoll句柄 int epFd = epoll_create(EPOLL_SIZE); （2）加入一个句柄到 epoll的监听队列 ev.data.fd = serverFd;ev.events = EPOLLIN | EPOLLET;epoll_ctl(epFd, EPOLL_CTL_ADD, serverFd, &amp;ev); 上 面的fd是你要绑定给事件发生时候使用的fd,到时候只能操作这个，下面是事件类型。 使用epoll_ctl添加到之中，EPOLL_CTL_ADD是epoll控制类型，这里监听的fd和给event的fd一般相同。 (3)等待event返回 int nfds = epoll_wait(epFd, evs, EVENT_ARR, -1); 传入的evs是epoll_event的数组，EVENT_ARR应当是不超过这个数组的长度。返回nfds的是不超过EVENT_ARR的数值，表示本次等待到了几个事件。 (4)遍历事件 注意，这里遍历的事件是肯定已经发生了的，而select中遍历的是每个fd，而fd不一定在FDSET中（即不一定有读事件发生）！这是效率最大的差别所在！ for (int i = 0; i &lt; nfds; i++) { //do something } (5)其他技巧 对事件是否是 serverFd判断，如果是，进行accept并加入epoll监听队列，要设置异步读取。 如果evts[i]&amp;EPOLLIN，表示可读，使用read进行试探，如果&gt;0表示连接没有关闭，否则连接已经关闭（出发事件又读取不到东西，表示socket关闭！）。如果&lt;0出错。如果&gt;0，需要继续读取直到为0，但是注意这里的为0是在第一次read不为0的前提下，毕竟我们设置了异步读取，暂时没有数据可以读就返回0了！而如果第一次返回0，那么就是关闭吧！ 注意关闭要移出出epoll并且 close(clientFd) 罗嗦了好多，看代码！ 1","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/archives/101"},"@type":"BlogPosting","url":"http://localhost:4000/archives/101","headline":"epoll和select","dateModified":"2010-04-29T13:04:49+08:00","datePublished":"2010-04-29T13:04:49+08:00","author":{"@type":"Person","name":"徐艺洲"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="徐艺洲" /></head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">徐艺洲</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/aboutme.html">关于我</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">epoll和select</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2010-04-29T13:04:49+08:00" itemprop="datePublished">Apr 29, 2010
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">徐艺洲</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div id="sina_keyword_ad_area2" class="articalContent   ">
  <p>
    转载的，感觉不错，所以留下备份
  </p>
  
  <p>
    来自于：http://m.cnblogs.com/62707/1681172.html
  </p>
  
  <p>
  </p>
  
  <p>
    epoll是Kernel 2.6后新加入的事件机制，在高并发条件下，远优于select.
  </p>
  
  <p>
    用个硬件中的例子吧，可能不太恰当：epoll相当于I／O中断（有的时候才相应），而select相当于轮询（总要反复查询）。
  </p>
  
  <p>
    其实epoll比slect好用很多， 主要一下几个用法。
  </p>
  
  <p>
    struct epoll_event ;epoll事件体，事件发生时候你可以得到一个它。其中epoll_event.data.fd可以存储关联的句柄，epoll_event.event是监听标志，常用的有EPOLLIN （有数据，可以读）、EPOLLOUT（有数据，可以写）EPOLLET（有事件，通用）;
  </p>
  
  <p>
    （1） 创建epoll句柄
  </p>
  
  <p>
    int epFd = epoll_create(EPOLL_SIZE);
  </p>
  
  <p>
    （2）加入一个句柄到 epoll的监听队列
  </p>
  
  <p>
    ev.data.fd = serverFd;<br />ev.events = EPOLLIN | EPOLLET;<br />epoll_ctl(epFd, EPOLL_CTL_ADD, serverFd, &amp;ev);
  </p>
  
  <p>
    上 面的fd是你要绑定给事件发生时候使用的fd,到时候只能操作这个，下面是事件类型。
  </p>
  
  <p>
    使用epoll_ctl添加到之中，EPOLL_CTL_ADD是epoll控制类型，这里监听的fd和给event的fd一般相同。
  </p>
  
  <p>
    (3)等待event返回
  </p>
  
  <p>
    int nfds = epoll_wait(epFd, evs, EVENT_ARR, -1);
  </p>
  
  <p>
    传入的evs是epoll_event的数组，EVENT_ARR应当是不超过这个数组的长度。返回nfds的是不超过EVENT_ARR的数值，表示本次等待到了几个事件。
  </p>
  
  <p>
    (4)遍历事件
  </p>
  
  <p>
    注意，这里遍历的事件是肯定已经发生了的，而select中遍历的是每个fd，而fd不一定在FDSET中（即不一定有读事件发生）！这是效率最大的差别所在！
  </p>
  
  <p>
    for (int i = 0; i &lt; nfds; i++)
  </p>
  
  <p>
    {
  </p>
  
  <p>
    //do something
  </p>
  
  <p>
    }
  </p>
  
  <p>
    (5)其他技巧
  </p>
  
  <p>
    对事件是否是 serverFd判断，如果是，进行accept并加入epoll监听队列，要设置异步读取。
  </p>
  
  <p>
    如果evts[i]&amp;EPOLLIN，表示可读，使用read进行试探，如果&gt;0表示连接没有关闭，否则连接已经关闭（出发事件又读取不到东西，表示socket关闭！）。如果&lt;0出错。如果&gt;0，需要继续读取直到为0，但是注意这里的为0是在第一次read不为0的前提下，毕竟我们设置了异步读取，暂时没有数据可以读就返回0了！而如果第一次返回0，那么就是关闭吧！
  </p>
  
  <p>
    注意关闭要移出出epoll并且 close(clientFd)
  </p>
  
  <p>
    罗嗦了好多，看代码！
  </p>
  
  <div>
    <div>
    </div>
  </div><div alt1=""> 
  
  <table>
    <tr>
      <td>
        <code>1</code>
      </td>
      
      <td>
      </td>
    </tr>
  </table>
</div><div alt1=""> 

<table>
  <tr>
    <td>
      <code>11</code>
    </td>
    
    <td>
      <code preprocessor="">#include&lt;stdio.h&gt;</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>12</code>
    </td>
    
    <td>
      <code preprocessor="">#include&lt;stdlib.h&gt;</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>13</code>
    </td>
    
    <td>
      <code preprocessor="">#include&lt;unistd.h&gt;</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>14</code>
    </td>
    
    <td>
      <code preprocessor="">#include&lt;fcntl.h&gt;</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>15</code>
    </td>
    
    <td>
      <code preprocessor="">#include&lt;arpa/inet.h&gt;</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>16</code>
    </td>
    
    <td>
      <code preprocessor="">#include&lt;netinet/in.h&gt;</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>17</code>
    </td>
    
    <td>
      <code preprocessor="">#include&lt;sys/epoll.h&gt;</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>18</code>
    </td>
    
    <td>
      <code preprocessor="">#include&lt;errno.h&gt;</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>19</code>
    </td>
    
    <td>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>20</code>
    </td>
    
    <td>
      <code preprocessor="">#define EPOLL_SIZE 10</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>21</code>
    </td>
    
    <td>
      <code preprocessor="">#define EVENT_ARR 20</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>22</code>
    </td>
    
    <td>
      <code preprocessor="">#define BACK_QUEUE 10</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>23</code>
    </td>
    
    <td>
      <code preprocessor="">#define PORT 18001</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>24</code>
    </td>
    
    <td>
      <code preprocessor="">#define BUF_SIZE 16</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>25</code>
    </td>
    
    <td>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>26</code>
    </td>
    
    <td>
      <code keyword="" bold="">void</code> <code plain="">setnonblocking(</code><code color1="" bold="">int</code><code plain="">sockFd) {</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>27</code>
    </td>
    
    <td>
      <code>    </code><code color1="" bold="">int</code> <code plain="">opt;</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>28</code>
    </td>
    
    <td>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>29</code>
    </td>
    
    <td>
      <code>    </code><code comments="">//获取sock原来的flag</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>30</code>
    </td>
    
    <td>
      <code>    </code><code plain="">opt= fcntl(sockFd, F_GETFL);</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>31</code>
    </td>
    
    <td>
      <code>    </code><code keyword="" bold="">if</code> <code plain="">(opt &lt; 0){</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>32</code>
    </td>
    
    <td>
      <code>        </code><code functions="" bold="">printf</code><code plain="">(</code><code string="">"fcntl(F_GETFL) fail."</code><code plain="">);</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>33</code>
    </td>
    
    <td>
      <code>        </code><code functions="" bold="">exit</code><code plain="">(-1);</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>34</code>
    </td>
    
    <td>
      <code>    </code><code plain="">}</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>35</code>
    </td>
    
    <td>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>36</code>
    </td>
    
    <td>
      <code>    </code><code comments="">//设置新的flag,非阻塞</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>37</code>
    </td>
    
    <td>
      <code>    </code><code plain="">opt|= O_NONBLOCK;</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>38</code>
    </td>
    
    <td>
      <code>    </code><code keyword="" bold="">if</code> <code plain="">(fcntl(sockFd, F_SETFL, opt)&lt; 0) {</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>39</code>
    </td>
    
    <td>
      <code>        </code><code functions="" bold="">printf</code><code plain="">(</code><code string="">"fcntl(F_SETFL) fail."</code><code plain="">);</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>40</code>
    </td>
    
    <td>
      <code>        </code><code functions="" bold="">exit</code><code plain="">(-1);</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>41</code>
    </td>
    
    <td>
      <code>    </code><code plain="">}</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>42</code>
    </td>
    
    <td>
      <code plain="">}</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>43</code>
    </td>
    
    <td>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>44</code>
    </td>
    
    <td>
      <code color1="" bold="">int</code> <code plain="">main(){</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>45</code>
    </td>
    
    <td>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>46</code>
    </td>
    
    <td>
      <code>    </code><code color1="" bold="">int</code> <code plain="">serverFd;</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>47</code>
    </td>
    
    <td>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tbo dy="">&lt;/p&gt; 
  
  <tr>
    <td>
      <code>48</code>
    </td>
    
    <td>
      <code>    </code><code comments="">//创建服务器fd</code>
    </td>
  </tr>&lt;/tbody&gt;
&lt;/table&gt;&lt;/div&gt; <div alt1=""> 

<table>
  <tr>
    <td>
      <code>49</code>
    </td>
    
    <td>
      <code>    </code><code plain="">serverFd= socket(AF_INET, SOCK_STREAM, 0);</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>50</code>
    </td>
    
    <td>
      <code>    </code><code plain="">setnonblocking(serverFd);</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>51</code>
    </td>
    
    <td>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>52</code>
    </td>
    
    <td>
      <code>    </code><code comments="">//创建epoll，并把serverFd放入监听队列</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>53</code>
    </td>
    
    <td>
      <code>    </code><code color1="" bold="">int</code> <code plain="">epFd =epoll_create(EPOLL_SIZE);</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>54</code>
    </td>
    
    <td>
      <code>    </code><code keyword="" bold="">struct</code> <code plain="">epoll_event ev,evs[EVENT_ARR];</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>55</code>
    </td>
    
    <td>
      <code>    </code><code plain="">ev.data.fd= serverFd;</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>56</code>
    </td>
    
    <td>
      <code>    </code><code plain="">ev.events= EPOLLIN | EPOLLET;</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>57</code>
    </td>
    
    <td>
      <code>    </code><code plain="">epoll_ctl(epFd,EPOLL_CTL_ADD, serverFd, &amp;ev);</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>58</code>
    </td>
    
    <td>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>59</code>
    </td>
    
    <td>
      <code>    </code><code comments="">//绑定服务器端口</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>60</code>
    </td>
    
    <td>
      <code>    </code><code keyword="" bold="">struct</code> <code plain="">sockaddr_inserverAddr;</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>61</code>
    </td>
    
    <td>
      <code>    </code><code plain="">socklen_tserverLen =</code> <code keyword="" bold="">sizeof</code><code plain="">(</code><code keyword="" bold="">struct</code> <code plain="">sockaddr_in);</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>62</code>
    </td>
    
    <td>
      <code>    </code><code plain="">serverAddr.sin_addr.s_addr= htonl(INADDR_ANY);</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>63</code>
    </td>
    
    <td>
      <code>    </code><code plain="">serverAddr.sin_port= htons(PORT);</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>64</code>
    </td>
    
    <td>
      <code>    </code><code keyword="" bold="">if</code> <code plain="">(bind(serverFd,(</code><code keyword="" bold="">struct</code> <code plain="">sockaddr *) &amp;serverAddr, serverLen)){</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>65</code>
    </td>
    
    <td>
      <code>        </code><code functions="" bold="">printf</code><code plain="">(</code><code string="">"bind()fail.\n"</code><code plain="">);</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>66</code>
    </td>
    
    <td>
      <code>        </code><code functions="" bold="">exit</code><code plain="">(-1);</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>67</code>
    </td>
    
    <td>
      <code>    </code><code plain="">}</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>68</code>
    </td>
    
    <td>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>69</code>
    </td>
    
    <td>
      <code>    </code><code comments="">//打开监听</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>70</code>
    </td>
    
    <td>
      <code>    </code><code keyword="" bold="">if</code> <code plain="">(listen(serverFd, BACK_QUEUE)){</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>71</code>
    </td>
    
    <td>
      <code>        </code><code functions="" bold="">printf</code><code plain="">(</code><code string="">"Listenfail.\n"</code><code plain="">);</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>72</code>
    </td>
    
    <td>
      <code>        </code><code functions="" bold="">exit</code><code plain="">(-1);</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>73</code>
    </td>
    
    <td>
      <code>    </code><code plain="">}</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>74</code>
    </td>
    
    <td>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>75</code>
    </td>
    
    <td>
      <code>    </code><code comments="">//死循环处理</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>76</code>
    </td>
    
    <td>
      <code>    </code><code color1="" bold="">int</code> <code plain="">clientFd;</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>77</code>
    </td>
    
    <td>
      <code>    </code><code plain="">sockaddr_inclientAddr;</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>78</code>
    </td>
    
    <td>
      <code>    </code><code plain="">socklen_tclientLen;</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>79</code>
    </td>
    
    <td>
      <code>    </code><code color1="" bold="">char</code> <code plain="">buf[BUF_SIZE];</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>80</code>
    </td>
    
    <td>
      <code>    </code><code keyword="" bold="">while</code> <code plain="">(1) {</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>81</code>
    </td>
    
    <td>
      <code>        </code><code comments="">//等待epoll事件的到来，最多取EVENT_ARR个事件</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>82</code>
    </td>
    
    <td>
      <code>        </code><code color1="" bold="">int</code> <code plain="">nfds = epoll_wait(epFd, evs,EVENT_ARR, -1);</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>83</code>
    </td>
    
    <td>
      <code>        </code><code comments="">//处理事件</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>84</code>
    </td>
    
    <td>
      <code>        </code><code keyword="" bold="">for</code> <code plain="">(</code><code color1="" bold="">int</code> <code plain="">i = 0; i &lt; nfds; i++){</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>85</code>
    </td>
    
    <td>
      <code>            </code><code keyword="" bold="">if</code> <code plain="">(evs[i].data.fd == serverFd&amp;&amp; evs[i].data.fd &amp;EPOLLIN) {</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>86</code>
    </td>
    
    <td>
      <code>                </code><code comments="">//如果是serverFd,表明有新连接连入</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>87</code>
    </td>
    
    <td>
      <code>                </code><code keyword="" bold="">if</code> <code plain="">((clientFd =accept(serverFd,</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>88</code>
    </td>
    
    <td>
      <code>                        </code><code plain="">(</code><code keyword="" bold="">struct</code> <code plain="">sockaddr *)&amp;clientAddr, &amp;clientLen))&lt; 0) {</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>89</code>
    </td>
    
    <td>
      <code>                    </code><code functions="" bold="">printf</code><code plain="">(</code><code string="">"acceptfail.\n"</code><code plain="">);</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>90</code>
    </td>
    
    <td>
      <code>                </code><code plain="">}</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>91</code>
    </td>
    
    <td>
      <code>                </code><code functions="" bold="">printf</code><code plain="">(</code><code string="">"Connect from %s:%d\n"</code><code plain="">,inet_ntoa(clientAddr.sin_addr),</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>92</code>
    </td>
    
    <td>
      <code>                        </code><code plain="">htons(clientAddr.sin_port));</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>93</code>
    </td>
    
    <td>
      <code>&lt;br /&gt;
       </code><code plain="">setnonblocking(clientFd);</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>94</code>
    </td>
    
    <td>
      <code>                </code><code comments="">//注册accept()到的连接</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>95</code>
    </td>
    
    <td>
      <code>                </code><code plain="">ev.data.fd= clientFd;</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>96</code>
    </td>
    
    <td>
      <code>                </code><code plain="">ev.events= EPOLLIN | EPOLLET;</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>97</code>
    </td>
    
    <td>
      <code>                </code><code plain="">epoll_ctl(epFd,EPOLL_CTL_ADD, clientFd, &amp;ev);</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>98</code>
    </td>
    
    <td>
      <code>            </code><code plain="">}</code><code keyword="" bold="">else</code> <code keyword="" bold="">if</code> <code plain="">(evs[i].events &amp;EPOLLIN) {</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>99</code>
    </td>
    
    <td>
      <code>                </code><code comments="">//如果不是serverFd,则是client的可读</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>100</code>
    </td>
    
    <td>
      <code>                </code><code keyword="" bold="">if</code> <code plain="">((clientFd = evs[i].data.fd)&gt; 0) {</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>101</code>
    </td>
    
    <td>
      <code>                    </code><code comments="">//先进行试探性读取</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>102</code>
    </td>
    
    <td>
      <code>                    </code><code color1="" bold="">int</code> <code plain="">len = read(clientFd, buf,BUF_SIZE);</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>103</code>
    </td>
    
    <td>
      <code>                    </code><code keyword="" bold="">if</code> <code plain="">(len &gt; 0){</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>104</code>
    </td>
    
    <td>
      <code>                        </code><code comments="">//有数据可以读，Echo写入</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>105</code>
    </td>
    
    <td>
      <code>                        </code><code keyword="" bold="">do</code> <code plain="">{</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>106</code>
    </td>
    
    <td>
      <code>                            </code><code keyword="" bold="">if</code> <code plain="">(write(clientFd, buf, len)&lt; 0) {</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>107</code>
    </td>
    
    <td>
      <code>                                </code><code functions="" bold="">printf</code><code plain="">(</code><code string="">"write() fail.\n"</code><code plain="">);</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>108</code>
    </td>
    
    <td>
      <code>                            </code><code plain="">}</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>109</code>
    </td>
    
    <td>
      <code>                            </code><code plain="">len= read(clientFd, buf, BUF_SIZE);</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>110</code>
    </td>
    
    <td>
      <code>                        </code><code plain="">}</code><code keyword="" bold="">while</code> <code plain="">(len&gt; 0);</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>111</code>
    </td>
    
    <td>
      <code>                    </code><code plain="">}</code><code keyword="" bold="">else</code> <code keyword="" bold="">if</code> <code plain="">(len == 0) {</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>112</code>
    </td>
    
    <td>
      <code>                        </code><code comments="">//出发了EPOLLIN事件，却没有可以读取的，表示断线</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>113</code>
    </td>
    
    <td>
      <code>                        </code><code functions="" bold="">printf</code><code plain="">(</code><code string="">"Clientclosed at %d\n"</code><code plain="">, clientFd);</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>114</code>
    </td>
    
    <td>
      <code>                        </code><code plain="">epoll_ctl(epFd,EPOLL_CTL_DEL, clientFd, &amp;ev);</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>115</code>
    </td>
    
    <td>
      <code>                        </code><code plain="">close(clientFd);</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>116</code>
    </td>
    
    <td>
      <code>                        </code><code plain="">evs[i].data.fd= -1;</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>117</code>
    </td>
    
    <td>
      <code>                        </code><code keyword="" bold="">break</code><code plain="">;</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>118</code>
    </td>
    
    <td>
      <code>                    </code><code plain="">}</code><code keyword="" bold="">else</code> <code keyword="" bold="">if</code> <code plain="">(len == EAGAIN) {</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>119</code>
    </td>
    
    <td>
      <code>                        </code><code keyword="" bold="">continue</code><code plain="">;</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>120</code>
    </td>
    
    <td>
      <code>                    </code><code plain="">}</code><code keyword="" bold="">else</code> <code plain="">{</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>121</code>
    </td>
    
    <td>
      <code>                        </code><code comments="">//client读取出错</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>122</code>
    </td>
    
    <td>
      <code>                        </code><code functions="" bold="">printf</code><code plain="">(</code><code string="">"read()fail."</code><code plain="">);</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>123</code>
    </td>
    
    <td>
      <code>                    </code><code plain="">}</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>124</code>
    </td>
    
    <td>
      <code>                </code><code plain="">}</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>125</code>
    </td>
    
    <td>
      <code>            </code><code plain="">}</code><code keyword="" bold="">else</code> <code plain="">{</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>126</code>
    </td>
    
    <td>
      <code>                </code><code functions="" bold="">printf</code><code plain="">(</code><code string="">"otherevent.\n"</code><code plain="">);</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>127</code>
    </td>
    
    <td>
      <code>            </code><code plain="">}</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>128</code>
    </td>
    
    <td>
      <code>        </code><code plain="">}</code>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>129</code>
    </td>
    
    <td>
      <code>    </code><code plain="">}</code>
    </td>
  </tr>
</table></div> <div alt2=""> 

<table>
  <tr>
    <td>
      <code>130</code>
    </td>
    
    <td>
    </td>
  </tr>
</table></div> <div alt1=""> 

<table>
  <tr>
    <td>
      <code>131</code>
    </td>
    
    <td>
      <code>    </code><code keyword="" bold="">return</code> <code plain="">0;</code>
    </td>
  </tr>
</table></div> 

<table>
  <tr>
    <td>
      <code>132</code>
    </td>
    
    <td>
      <code plain="">}</code>
    </td>
  </tr>
</table>
</tbo></table></div></div>

  </div><a class="u-url" href="/archives/101" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col one-half">
      <h2 class="footer-heading">徐艺洲</h2>
        <ul class="contact-list">
          <li class="p-name"></li></ul>
      </div>

      <div class="footer-col one-half">
        <p>知止定静安虑得</p>
      </div>

      <div class="social-links"><ul class="social-media-list"></ul>
</div>
    </div>

  </div>

</footer>
</body>

</html>
