<div id="sina_keyword_ad_area2" class="articalContent   ">
  php的libev扩展<br />提供了一些类似nodejs异步调用的方式，<br />用途很多，如文件状态监视，流阻塞等待异步<br />pecl库的，默认不安装，需要自己在pecl下弄个过来<br />php manual地址：http://www.php.net/manual/zh/ev.examples.php<br />如果不知道libev是啥可以看这个http://dirlt.com/libev.html<br />这里罗列下具体手册内的代码，只翻译了关键注释<br />刚才由于对代码没有整理，竟然被过滤掉了……不能发html pre代码的博客编辑器好凄惨&lt;/p&gt; 
  
  <p>
    <code>&lt;span STYLE="color: #000000"&gt;&lt;span STYLE="color: #FF8000"&gt;//创建一个定时器，2秒后启动，不循环只执行一次&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w1 &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= new &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;EvTimer&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;2&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;0&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, function () {&lt;br /&gt;    echo &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"2 seconds elapsed\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;br /&gt;});&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//创建一个定时器，2秒后启动，1秒执行一次&lt;br /&gt;// 直到碰到指定代码停止&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w2 &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= new &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;EvTimer&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;2&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;1&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, function (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;) {&lt;br /&gt;    echo &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"is called every second, is launched after 2 seconds\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;br /&gt;    echo &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"iteration = "&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;iteration&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(), &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;PHP_EOL&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;/p&gt;
&lt;p&gt;    &lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//执行第五次停止&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;iteration&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;() == &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;5 &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;and &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;stop&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;// Stop the watcher if further calls cause more than 10 iterations&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;iteration&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;() &gt;= &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;10 &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;and &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;stop&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;br /&gt;});&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//创建计时器，未激活，需要代码激活&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w_stopped &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;EvTimer&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;createStopped&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;10&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;5&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, function(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;) {&lt;br /&gt;    echo &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"Callback of a timer created as stopped\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;/p&gt;
&lt;p&gt;    &lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//事件产生两次后停止定时器&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;iteration&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;() &gt;= &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;2 &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;and &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;stop&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;br /&gt;});&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//循环直到所有都关闭&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;run&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//启动并检查是否开始工作&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w_stopped&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;start&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;br /&gt;echo &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"Run single iteration\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;run&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;RUN_ONCE&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;/p&gt;
&lt;p&gt;echo &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"重启定时器，并尝试继续处理相同事件，但是这次是非阻塞的方式\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w2&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;again&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;run&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;RUN_NOWAIT&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= new &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;EvTimer&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;10&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;0&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, function() {});&lt;br /&gt;echo &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"阻塞方式运行\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;run&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;br /&gt;echo &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"END\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;/span&gt;&lt;/span&gt;</code>
  </p>
  
  <p>
    ========================<br /><code>&lt;span STYLE="color: #000000"&gt;&lt;span STYLE="color: #FF8000"&gt;//等待一直到STDIN准备好并可读&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= new &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;EvIo&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;STDIN&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;READ&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, function (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$watcher&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$revents&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;) {&lt;br /&gt;    echo &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"STDIN is readable\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;br /&gt;});&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;run&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;RUN_ONCE&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;/span&gt;&lt;/span&gt;</code>
  </p>
  
  <p>
    ========================<br />非阻塞<br /><code>&lt;span STYLE="color: #000000"&gt;&lt;span STYLE="color: #0000BB"&gt;$e_nonblocking &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= array (&lt;/span&gt;&lt;span STYLE="
color: #0000BB"&gt;11&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;115&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;/p&gt;
&lt;p&gt;&lt;/span&gt; &lt;span STYLE="color: #FF8000"&gt;//获取www服务服务端口&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$service_port &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;getservbyname&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;'www'&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;'tcp'&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//获取域名对应ip&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$address &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;gethostbyname&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;'google.co.uk'&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//创建socket通讯&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;socket_create&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;AF_INET&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;SOCK_STREAM&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;SOL_TCP&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;br /&gt;if (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;=== &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;FALSE&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;) {&lt;br /&gt;    echo &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"socket_create() failed: reason: "&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;.&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;socket_strerror&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;socket_last_error&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;()) . &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;br /&gt;}&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//表示非阻塞方式&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;socket_set_nonblock&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//如果在使用中超时自动关闭，这里用了evtimer&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$timeout_watcher &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= new &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;EvTimer&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;10.0&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;0.&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, function () use (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;) {&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;socket_close&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;stop&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;BREAK_ALL&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;br /&gt;});&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//当socket可用后，进行发送接收操作&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$write_watcher &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= new &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;EvIo&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;WRITE&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, function (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;)&lt;br /&gt;    use (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$timeout_watcher&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$e_nonblocking&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;)&lt;br /&gt;{&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//超时timer停用&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$timeout_watcher&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;stop&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//停用evio监视&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;stop&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;/p&gt;
&lt;p&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$in &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"HEAD / HTTP/1.1\r\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$in &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;.= &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"Host: google.co.uk\r\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$in &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;.= &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"Connection: Close\r\n\r\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;/p&gt;
&lt;p&gt;    if (!&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;socket_write&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$in&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;strlen&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$in&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;))) {&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;trigger_error&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"Failed writing &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$in&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt; to socket"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;E_USER_ERROR&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;br /&gt;    }&lt;/p&gt;
&lt;p&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$read_watcher &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= new &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;EvIo&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;READ&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, function (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$re&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;)&lt;br /&gt;        use (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$e_nonblocking&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;)&lt;br /&gt;    {&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//非阻塞情况下从socket读取20字节数据&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$ret &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;socket_recv&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$out&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;20&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;MSG_DONTWAIT&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;/p&gt;
&lt;p&gt;        if (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$ret&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;) {&lt;br /&gt;            echo &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$out&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;br /&gt;        } elseif (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$ret &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;=== &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;0&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;) {&lt;br /&gt;            &lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//读取完毕&lt;br /&gt;            &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;stop&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;br /&gt;            &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;socket_close&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;br /&gt;            return;&lt;br /&gt;        }&lt;br /
&gt;&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//socket通讯错误&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;if (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;in_array&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;socket_last_error&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(), &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$e_nonblocking&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;)) {&lt;br /&gt;            return;&lt;br /&gt;        }&lt;/p&gt;
&lt;p&gt;        &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;stop&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;socket_close&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;br /&gt;    });&lt;/p&gt;
&lt;p&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;run&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;br /&gt;});&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$result &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;socket_connect&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$address&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$service_port&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;run&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;/span&gt;&lt;/span&gt;</code>
  </p>
  
  <p>
    ===========================<br />信号处理，当收到控制信号时自动启动<br /><code>&lt;span STYLE="color: #000000"&gt;&lt;span STYLE="color: #0000BB"&gt;$w &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= new &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;EvSignal&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;SIGTERM&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, function (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$watcher&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;) {&lt;br /&gt;    echo &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"SIGTERM received\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$watcher&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;stop&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;br /&gt;});&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;run&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;/span&gt;&lt;/span&gt;</code>
  </p>
  
  <p>
    ===========================<br /><code>&lt;span STYLE="color: #000000"&gt;&lt;span STYLE="color: #FF8000"&gt;//指定文件修改监视当监视文件出现变化，则触发，每8秒检查一次&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= new &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;EvStat&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"/var/log/messages"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;8&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, function (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;) {&lt;br /&gt;    echo &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"/var/log/messages changed\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;/p&gt;
&lt;p&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$attr &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;attr&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;/p&gt;
&lt;p&gt;    if (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$attr&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;[&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;'nlink'&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;]) {&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;printf&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"Current size: %ld\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$attr&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;[&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;'size'&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;]);&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;printf&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"Current atime: %ld\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$attr&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;[&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;'atime'&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;]);&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;printf&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"Current mtime: %ld\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$attr&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;[&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;'mtime'&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;]);&lt;br /&gt;    } else {&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;fprintf&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;STDERR&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"`messages` file is not there!"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;stop&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;br /&gt;    }&lt;br /&gt;});&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;run&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;/span&gt;&lt;/span&gt;</code>
  </p>
  
  <p>
    ============================<br />进程状态监视<br /><code>&lt;span STYLE="color: #000000"&gt;&lt;span STYLE="color: #0000BB"&gt;$pid &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;pcntl_fork&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;/p&gt;
&lt;p&gt;if (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$pid &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;== -&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;1&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;) {&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;fprintf&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;STDERR&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"pcntl_fork failed\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;br /&gt;} elseif (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$pid&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;) {&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= new &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;EvChild&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$pid&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;FALSE&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, function (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$revents&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;) {&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;stop&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;/p&gt;
&lt;p&gt;        &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;printf&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"Process %d exited with status %d\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;rpid&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;rstatus&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;br /&gt;    });&lt;/p&gt;
&lt;p&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;run&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;/p&gt;
&lt;p&gt;    &lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;// Protect against Zombies&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;pcntl_wait&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$status&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;br /&gt;} else {&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//Forked child&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;exit(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;2&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;br /&gt;}&lt;/span&gt;&lt;/span&gt;</code>
  </p>
</div>
