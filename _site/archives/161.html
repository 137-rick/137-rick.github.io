<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>PHP扩展ev示例翻译 | 徐艺洲</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="PHP扩展ev示例翻译" />
<meta name="author" content="徐艺洲" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="php的libev扩展提供了一些类似nodejs异步调用的方式，用途很多，如文件状态监视，流阻塞等待异步pecl库的，默认不安装，需要自己在pecl下弄个过来php manual地址：http://www.php.net/manual/zh/ev.examples.php如果不知道libev是啥可以看这个http://dirlt.com/libev.html这里罗列下具体手册内的代码，只翻译了关键注释刚才由于对代码没有整理，竟然被过滤掉了……不能发html pre代码的博客编辑器好凄惨&lt;/p&gt; &lt;span STYLE=&quot;color: #000000&quot;&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//创建一个定时器，2秒后启动，不循环只执行一次&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w1 &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvTimer&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;2&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;0&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function () {&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;2 seconds elapsed\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt;});&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//创建一个定时器，2秒后启动，1秒执行一次&lt;br /&gt;// 直到碰到指定代码停止&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w2 &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvTimer&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;2&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;1&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;is called every second, is launched after 2 seconds\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;iteration = &quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;iteration&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(), &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;PHP_EOL&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//执行第五次停止&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;iteration&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;() == &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;5 &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;and &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;// Stop the watcher if further calls cause more than 10 iterations&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;iteration&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;() &gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;10 &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;and &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt;});&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//创建计时器，未激活，需要代码激活&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w_stopped &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvTimer&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;createStopped&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;10&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;5&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Callback of a timer created as stopped\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//事件产生两次后停止定时器&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;iteration&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;() &gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;2 &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;and &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt;});&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//循环直到所有都关闭&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//启动并检查是否开始工作&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w_stopped&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;start&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt;echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Run single iteration\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;RUN_ONCE&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/p&gt; &lt;p&gt;echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;重启定时器，并尝试继续处理相同事件，但是这次是非阻塞的方式\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w2&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;again&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;RUN_NOWAIT&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvTimer&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;10&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;0&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function() {});&lt;br /&gt;echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;阻塞方式运行\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt;echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;END\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;/span&gt;&lt;/span&gt; ========================&lt;span STYLE=&quot;color: #000000&quot;&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//等待一直到STDIN准备好并可读&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvIo&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;STDIN&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;READ&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$watcher&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$revents&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;STDIN is readable\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt;});&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;RUN_ONCE&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/span&gt;&lt;/span&gt; ========================非阻塞&lt;span STYLE=&quot;color: #000000&quot;&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$e_nonblocking &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= array (&lt;/span&gt;&lt;span STYLE=&quot; color: #0000BB&quot;&gt;11&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;115&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/p&gt; &lt;p&gt;&lt;/span&gt; &lt;span STYLE=&quot;color: #FF8000&quot;&gt;//获取www服务服务端口&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$service_port &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;getservbyname&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&#39;www&#39;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&#39;tcp&#39;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//获取域名对应ip&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$address &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;gethostbyname&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&#39;google.co.uk&#39;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//创建socket通讯&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_create&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;AF_INET&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;SOCK_STREAM&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;SOL_TCP&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt;if (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;=== &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;FALSE&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;socket_create() failed: reason: &quot;&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;.&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_strerror&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_last_error&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;()) . &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt;}&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//表示非阻塞方式&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_set_nonblock&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//如果在使用中超时自动关闭，这里用了evtimer&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$timeout_watcher &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvTimer&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;10.0&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;0.&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function () use (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_close&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;BREAK_ALL&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt;});&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//当socket可用后，进行发送接收操作&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$write_watcher &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvIo&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;WRITE&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;)&lt;br /&gt; use (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$timeout_watcher&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$e_nonblocking&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;)&lt;br /&gt;{&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//超时timer停用&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$timeout_watcher&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//停用evio监视&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$in &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;HEAD / HTTP/1.1\r\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$in &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;.= &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Host: google.co.uk\r\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$in &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;.= &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Connection: Close\r\n\r\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;/p&gt; &lt;p&gt; if (!&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_write&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$in&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;strlen&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$in&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;))) {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;trigger_error&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Failed writing &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$in&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt; to socket&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;E_USER_ERROR&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt; }&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$read_watcher &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvIo&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;READ&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$re&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;)&lt;br /&gt; use (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$e_nonblocking&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;)&lt;br /&gt; {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//非阻塞情况下从socket读取20字节数据&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$ret &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_recv&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$out&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;20&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;MSG_DONTWAIT&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/p&gt; &lt;p&gt; if (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$ret&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$out&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt; } elseif (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$ret &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;=== &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;0&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//读取完毕&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_close&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt; return;&lt;br /&gt; }&lt;br / &gt;&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//socket通讯错误&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;if (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;in_array&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_last_error&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(), &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$e_nonblocking&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;)) {&lt;br /&gt; return;&lt;br /&gt; }&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_close&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt; });&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt;});&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$result &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_connect&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$address&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$service_port&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/span&gt;&lt;/span&gt; ===========================信号处理，当收到控制信号时自动启动&lt;span STYLE=&quot;color: #000000&quot;&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvSignal&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;SIGTERM&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$watcher&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;SIGTERM received\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$watcher&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt;});&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/span&gt;&lt;/span&gt; ===========================&lt;span STYLE=&quot;color: #000000&quot;&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//指定文件修改监视当监视文件出现变化，则触发，每8秒检查一次&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvStat&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;/var/log/messages&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;8&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;/var/log/messages changed\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$attr &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;attr&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/p&gt; &lt;p&gt; if (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$attr&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;[&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&#39;nlink&#39;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;]) {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;printf&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Current size: %ld\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$attr&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;[&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&#39;size&#39;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;]);&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;printf&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Current atime: %ld\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$attr&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;[&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&#39;atime&#39;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;]);&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;printf&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Current mtime: %ld\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$attr&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;[&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&#39;mtime&#39;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;]);&lt;br /&gt; } else {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;fprintf&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;STDERR&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;`messages` file is not there!&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt; }&lt;br /&gt;});&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/span&gt;&lt;/span&gt; ============================进程状态监视&lt;span STYLE=&quot;color: #000000&quot;&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$pid &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;pcntl_fork&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/p&gt; &lt;p&gt;if (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$pid &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;== -&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;1&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;fprintf&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;STDERR&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;pcntl_fork failed\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt;} elseif (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$pid&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvChild&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$pid&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;FALSE&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$revents&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;printf&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Process %d exited with status %d\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;rpid&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;rstatus&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt; });&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;// Protect against Zombies&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;pcntl_wait&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$status&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt;} else {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//Forked child&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;exit(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;2&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt;}&lt;/span&gt;&lt;/span&gt;" />
<meta property="og:description" content="php的libev扩展提供了一些类似nodejs异步调用的方式，用途很多，如文件状态监视，流阻塞等待异步pecl库的，默认不安装，需要自己在pecl下弄个过来php manual地址：http://www.php.net/manual/zh/ev.examples.php如果不知道libev是啥可以看这个http://dirlt.com/libev.html这里罗列下具体手册内的代码，只翻译了关键注释刚才由于对代码没有整理，竟然被过滤掉了……不能发html pre代码的博客编辑器好凄惨&lt;/p&gt; &lt;span STYLE=&quot;color: #000000&quot;&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//创建一个定时器，2秒后启动，不循环只执行一次&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w1 &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvTimer&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;2&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;0&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function () {&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;2 seconds elapsed\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt;});&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//创建一个定时器，2秒后启动，1秒执行一次&lt;br /&gt;// 直到碰到指定代码停止&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w2 &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvTimer&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;2&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;1&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;is called every second, is launched after 2 seconds\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;iteration = &quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;iteration&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(), &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;PHP_EOL&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//执行第五次停止&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;iteration&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;() == &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;5 &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;and &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;// Stop the watcher if further calls cause more than 10 iterations&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;iteration&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;() &gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;10 &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;and &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt;});&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//创建计时器，未激活，需要代码激活&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w_stopped &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvTimer&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;createStopped&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;10&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;5&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Callback of a timer created as stopped\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//事件产生两次后停止定时器&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;iteration&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;() &gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;2 &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;and &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt;});&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//循环直到所有都关闭&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//启动并检查是否开始工作&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w_stopped&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;start&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt;echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Run single iteration\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;RUN_ONCE&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/p&gt; &lt;p&gt;echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;重启定时器，并尝试继续处理相同事件，但是这次是非阻塞的方式\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w2&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;again&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;RUN_NOWAIT&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvTimer&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;10&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;0&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function() {});&lt;br /&gt;echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;阻塞方式运行\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt;echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;END\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;/span&gt;&lt;/span&gt; ========================&lt;span STYLE=&quot;color: #000000&quot;&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//等待一直到STDIN准备好并可读&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvIo&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;STDIN&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;READ&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$watcher&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$revents&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;STDIN is readable\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt;});&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;RUN_ONCE&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/span&gt;&lt;/span&gt; ========================非阻塞&lt;span STYLE=&quot;color: #000000&quot;&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$e_nonblocking &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= array (&lt;/span&gt;&lt;span STYLE=&quot; color: #0000BB&quot;&gt;11&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;115&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/p&gt; &lt;p&gt;&lt;/span&gt; &lt;span STYLE=&quot;color: #FF8000&quot;&gt;//获取www服务服务端口&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$service_port &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;getservbyname&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&#39;www&#39;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&#39;tcp&#39;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//获取域名对应ip&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$address &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;gethostbyname&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&#39;google.co.uk&#39;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//创建socket通讯&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_create&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;AF_INET&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;SOCK_STREAM&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;SOL_TCP&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt;if (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;=== &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;FALSE&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;socket_create() failed: reason: &quot;&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;.&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_strerror&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_last_error&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;()) . &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt;}&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//表示非阻塞方式&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_set_nonblock&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//如果在使用中超时自动关闭，这里用了evtimer&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$timeout_watcher &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvTimer&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;10.0&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;0.&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function () use (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_close&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;BREAK_ALL&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt;});&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//当socket可用后，进行发送接收操作&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$write_watcher &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvIo&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;WRITE&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;)&lt;br /&gt; use (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$timeout_watcher&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$e_nonblocking&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;)&lt;br /&gt;{&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//超时timer停用&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$timeout_watcher&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//停用evio监视&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$in &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;HEAD / HTTP/1.1\r\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$in &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;.= &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Host: google.co.uk\r\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$in &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;.= &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Connection: Close\r\n\r\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;/p&gt; &lt;p&gt; if (!&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_write&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$in&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;strlen&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$in&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;))) {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;trigger_error&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Failed writing &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$in&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt; to socket&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;E_USER_ERROR&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt; }&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$read_watcher &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvIo&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;READ&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$re&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;)&lt;br /&gt; use (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$e_nonblocking&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;)&lt;br /&gt; {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//非阻塞情况下从socket读取20字节数据&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$ret &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_recv&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$out&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;20&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;MSG_DONTWAIT&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/p&gt; &lt;p&gt; if (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$ret&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$out&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt; } elseif (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$ret &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;=== &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;0&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//读取完毕&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_close&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt; return;&lt;br /&gt; }&lt;br / &gt;&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//socket通讯错误&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;if (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;in_array&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_last_error&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(), &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$e_nonblocking&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;)) {&lt;br /&gt; return;&lt;br /&gt; }&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_close&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt; });&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt;});&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$result &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_connect&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$address&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$service_port&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/span&gt;&lt;/span&gt; ===========================信号处理，当收到控制信号时自动启动&lt;span STYLE=&quot;color: #000000&quot;&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvSignal&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;SIGTERM&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$watcher&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;SIGTERM received\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$watcher&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt;});&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/span&gt;&lt;/span&gt; ===========================&lt;span STYLE=&quot;color: #000000&quot;&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//指定文件修改监视当监视文件出现变化，则触发，每8秒检查一次&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvStat&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;/var/log/messages&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;8&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;/var/log/messages changed\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$attr &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;attr&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/p&gt; &lt;p&gt; if (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$attr&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;[&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&#39;nlink&#39;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;]) {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;printf&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Current size: %ld\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$attr&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;[&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&#39;size&#39;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;]);&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;printf&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Current atime: %ld\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$attr&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;[&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&#39;atime&#39;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;]);&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;printf&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Current mtime: %ld\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$attr&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;[&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&#39;mtime&#39;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;]);&lt;br /&gt; } else {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;fprintf&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;STDERR&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;`messages` file is not there!&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt; }&lt;br /&gt;});&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/span&gt;&lt;/span&gt; ============================进程状态监视&lt;span STYLE=&quot;color: #000000&quot;&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$pid &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;pcntl_fork&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/p&gt; &lt;p&gt;if (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$pid &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;== -&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;1&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;fprintf&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;STDERR&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;pcntl_fork failed\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt;} elseif (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$pid&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvChild&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$pid&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;FALSE&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$revents&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;printf&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Process %d exited with status %d\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;rpid&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;rstatus&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt; });&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;// Protect against Zombies&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;pcntl_wait&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$status&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt;} else {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//Forked child&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;exit(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;2&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt;}&lt;/span&gt;&lt;/span&gt;" />
<link rel="canonical" href="http://localhost:4000/archives/161" />
<meta property="og:url" content="http://localhost:4000/archives/161" />
<meta property="og:site_name" content="徐艺洲" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2013-03-21T11:10:56+08:00" />
<script type="application/ld+json">
{"description":"php的libev扩展提供了一些类似nodejs异步调用的方式，用途很多，如文件状态监视，流阻塞等待异步pecl库的，默认不安装，需要自己在pecl下弄个过来php manual地址：http://www.php.net/manual/zh/ev.examples.php如果不知道libev是啥可以看这个http://dirlt.com/libev.html这里罗列下具体手册内的代码，只翻译了关键注释刚才由于对代码没有整理，竟然被过滤掉了……不能发html pre代码的博客编辑器好凄惨&lt;/p&gt; &lt;span STYLE=&quot;color: #000000&quot;&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//创建一个定时器，2秒后启动，不循环只执行一次&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w1 &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvTimer&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;2&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;0&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function () {&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;2 seconds elapsed\\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt;});&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//创建一个定时器，2秒后启动，1秒执行一次&lt;br /&gt;// 直到碰到指定代码停止&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w2 &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvTimer&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;2&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;1&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;is called every second, is launched after 2 seconds\\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;iteration = &quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;iteration&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(), &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;PHP_EOL&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//执行第五次停止&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;iteration&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;() == &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;5 &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;and &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;// Stop the watcher if further calls cause more than 10 iterations&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;iteration&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;() &gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;10 &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;and &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt;});&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//创建计时器，未激活，需要代码激活&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w_stopped &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvTimer&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;createStopped&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;10&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;5&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Callback of a timer created as stopped\\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//事件产生两次后停止定时器&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;iteration&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;() &gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;2 &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;and &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt;});&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//循环直到所有都关闭&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//启动并检查是否开始工作&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w_stopped&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;start&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt;echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Run single iteration\\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;RUN_ONCE&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/p&gt; &lt;p&gt;echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;重启定时器，并尝试继续处理相同事件，但是这次是非阻塞的方式\\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w2&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;again&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;RUN_NOWAIT&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvTimer&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;10&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;0&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function() {});&lt;br /&gt;echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;阻塞方式运行\\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt;echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;END\\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;/span&gt;&lt;/span&gt; ========================&lt;span STYLE=&quot;color: #000000&quot;&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//等待一直到STDIN准备好并可读&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvIo&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;STDIN&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;READ&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$watcher&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$revents&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;STDIN is readable\\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt;});&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;RUN_ONCE&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/span&gt;&lt;/span&gt; ========================非阻塞&lt;span STYLE=&quot;color: #000000&quot;&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$e_nonblocking &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= array (&lt;/span&gt;&lt;span STYLE=&quot; color: #0000BB&quot;&gt;11&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;115&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/p&gt; &lt;p&gt;&lt;/span&gt; &lt;span STYLE=&quot;color: #FF8000&quot;&gt;//获取www服务服务端口&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$service_port &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;getservbyname&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&#39;www&#39;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&#39;tcp&#39;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//获取域名对应ip&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$address &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;gethostbyname&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&#39;google.co.uk&#39;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//创建socket通讯&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_create&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;AF_INET&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;SOCK_STREAM&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;SOL_TCP&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt;if (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;=== &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;FALSE&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;socket_create() failed: reason: &quot;&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;.&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_strerror&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_last_error&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;()) . &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;\\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt;}&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//表示非阻塞方式&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_set_nonblock&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//如果在使用中超时自动关闭，这里用了evtimer&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$timeout_watcher &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvTimer&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;10.0&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;0.&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function () use (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_close&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;BREAK_ALL&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt;});&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//当socket可用后，进行发送接收操作&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$write_watcher &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvIo&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;WRITE&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;)&lt;br /&gt; use (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$timeout_watcher&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$e_nonblocking&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;)&lt;br /&gt;{&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//超时timer停用&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$timeout_watcher&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//停用evio监视&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$in &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;HEAD / HTTP/1.1\\r\\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$in &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;.= &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Host: google.co.uk\\r\\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$in &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;.= &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Connection: Close\\r\\n\\r\\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;/p&gt; &lt;p&gt; if (!&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_write&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$in&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;strlen&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$in&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;))) {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;trigger_error&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Failed writing &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$in&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt; to socket&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;E_USER_ERROR&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt; }&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$read_watcher &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvIo&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;READ&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$re&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;)&lt;br /&gt; use (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$e_nonblocking&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;)&lt;br /&gt; {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//非阻塞情况下从socket读取20字节数据&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$ret &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_recv&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$out&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;20&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;MSG_DONTWAIT&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/p&gt; &lt;p&gt; if (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$ret&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$out&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt; } elseif (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$ret &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;=== &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;0&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//读取完毕&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_close&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt; return;&lt;br /&gt; }&lt;br / &gt;&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//socket通讯错误&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;if (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;in_array&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_last_error&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(), &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$e_nonblocking&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;)) {&lt;br /&gt; return;&lt;br /&gt; }&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_close&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt; });&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt;});&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$result &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;socket_connect&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$socket&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$address&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$service_port&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/span&gt;&lt;/span&gt; ===========================信号处理，当收到控制信号时自动启动&lt;span STYLE=&quot;color: #000000&quot;&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvSignal&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;SIGTERM&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$watcher&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;SIGTERM received\\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$watcher&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt;});&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/span&gt;&lt;/span&gt; ===========================&lt;span STYLE=&quot;color: #000000&quot;&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//指定文件修改监视当监视文件出现变化，则触发，每8秒检查一次&lt;br /&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvStat&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;/var/log/messages&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;8&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; echo &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;/var/log/messages changed\\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;;&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$attr &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;attr&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/p&gt; &lt;p&gt; if (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$attr&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;[&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&#39;nlink&#39;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;]) {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;printf&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Current size: %ld\\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$attr&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;[&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&#39;size&#39;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;]);&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;printf&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Current atime: %ld\\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$attr&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;[&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&#39;atime&#39;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;]);&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;printf&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Current mtime: %ld\\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$attr&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;[&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&#39;mtime&#39;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;]);&lt;br /&gt; } else {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;fprintf&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;STDERR&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;`messages` file is not there!&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;br /&gt; }&lt;br /&gt;});&lt;/p&gt; &lt;p&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/span&gt;&lt;/span&gt; ============================进程状态监视&lt;span STYLE=&quot;color: #000000&quot;&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$pid &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;pcntl_fork&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/p&gt; &lt;p&gt;if (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$pid &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;== -&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;1&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;fprintf&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;STDERR&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;pcntl_fork failed\\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt;} elseif (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$pid&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;= new &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;EvChild&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$pid&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;FALSE&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, function (&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$revents&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;) {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;stop&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;printf&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #DD0000&quot;&gt;&quot;Process %d exited with status %d\\n&quot;&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;rpid&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;, &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$w&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;-&gt;&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;rstatus&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt; });&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;Ev&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;::&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;run&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;();&lt;/p&gt; &lt;p&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;// Protect against Zombies&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;pcntl_wait&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;$status&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt;} else {&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #FF8000&quot;&gt;//Forked child&lt;br /&gt; &lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;exit(&lt;/span&gt;&lt;span STYLE=&quot;color: #0000BB&quot;&gt;2&lt;/span&gt;&lt;span STYLE=&quot;color: #007700&quot;&gt;);&lt;br /&gt;}&lt;/span&gt;&lt;/span&gt;","datePublished":"2013-03-21T11:10:56+08:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/archives/161"},"url":"http://localhost:4000/archives/161","author":{"@type":"Person","name":"徐艺洲"},"headline":"PHP扩展ev示例翻译","dateModified":"2013-03-21T11:10:56+08:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="徐艺洲" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">徐艺洲</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/aboutme.html">关于我</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">PHP扩展ev示例翻译</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2013-03-21T11:10:56+08:00" itemprop="datePublished">Mar 21, 2013
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">徐艺洲</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div id="sina_keyword_ad_area2" class="articalContent   ">
  php的libev扩展<br />提供了一些类似nodejs异步调用的方式，<br />用途很多，如文件状态监视，流阻塞等待异步<br />pecl库的，默认不安装，需要自己在pecl下弄个过来<br />php manual地址：http://www.php.net/manual/zh/ev.examples.php<br />如果不知道libev是啥可以看这个http://dirlt.com/libev.html<br />这里罗列下具体手册内的代码，只翻译了关键注释<br />刚才由于对代码没有整理，竟然被过滤掉了……不能发html pre代码的博客编辑器好凄惨&lt;/p&gt; 
  
  <p>
    <code>&lt;span STYLE="color: #000000"&gt;&lt;span STYLE="color: #FF8000"&gt;//创建一个定时器，2秒后启动，不循环只执行一次&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w1 &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= new &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;EvTimer&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;2&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;0&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, function () {&lt;br /&gt;    echo &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"2 seconds elapsed\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;br /&gt;});&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//创建一个定时器，2秒后启动，1秒执行一次&lt;br /&gt;// 直到碰到指定代码停止&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w2 &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= new &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;EvTimer&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;2&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;1&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, function (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;) {&lt;br /&gt;    echo &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"is called every second, is launched after 2 seconds\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;br /&gt;    echo &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"iteration = "&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;iteration&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(), &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;PHP_EOL&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;/p&gt;
&lt;p&gt;    &lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//执行第五次停止&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;iteration&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;() == &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;5 &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;and &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;stop&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;// Stop the watcher if further calls cause more than 10 iterations&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;iteration&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;() &gt;= &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;10 &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;and &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;stop&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;br /&gt;});&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//创建计时器，未激活，需要代码激活&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w_stopped &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;EvTimer&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;createStopped&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;10&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;5&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, function(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;) {&lt;br /&gt;    echo &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"Callback of a timer created as stopped\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;/p&gt;
&lt;p&gt;    &lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//事件产生两次后停止定时器&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;iteration&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;() &gt;= &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;2 &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;and &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;stop&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;br /&gt;});&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//循环直到所有都关闭&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;run&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//启动并检查是否开始工作&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w_stopped&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;start&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;br /&gt;echo &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"Run single iteration\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;run&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;RUN_ONCE&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;/p&gt;
&lt;p&gt;echo &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"重启定时器，并尝试继续处理相同事件，但是这次是非阻塞的方式\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w2&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;again&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;run&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;RUN_NOWAIT&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= new &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;EvTimer&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;10&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;0&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, function() {});&lt;br /&gt;echo &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"阻塞方式运行\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;run&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;br /&gt;echo &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"END\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;/span&gt;&lt;/span&gt;</code>
  </p>
  
  <p>
    ========================<br /><code>&lt;span STYLE="color: #000000"&gt;&lt;span STYLE="color: #FF8000"&gt;//等待一直到STDIN准备好并可读&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= new &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;EvIo&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;STDIN&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;READ&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, function (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$watcher&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$revents&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;) {&lt;br /&gt;    echo &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"STDIN is readable\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;br /&gt;});&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;run&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;RUN_ONCE&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;/span&gt;&lt;/span&gt;</code>
  </p>
  
  <p>
    ========================<br />非阻塞<br /><code>&lt;span STYLE="color: #000000"&gt;&lt;span STYLE="color: #0000BB"&gt;$e_nonblocking &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= array (&lt;/span&gt;&lt;span STYLE="
color: #0000BB"&gt;11&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;115&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;/p&gt;
&lt;p&gt;&lt;/span&gt; &lt;span STYLE="color: #FF8000"&gt;//获取www服务服务端口&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$service_port &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;getservbyname&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;'www'&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;'tcp'&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//获取域名对应ip&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$address &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;gethostbyname&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;'google.co.uk'&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//创建socket通讯&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;socket_create&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;AF_INET&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;SOCK_STREAM&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;SOL_TCP&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;br /&gt;if (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;=== &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;FALSE&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;) {&lt;br /&gt;    echo &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"socket_create() failed: reason: "&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;.&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;socket_strerror&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;socket_last_error&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;()) . &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;br /&gt;}&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//表示非阻塞方式&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;socket_set_nonblock&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//如果在使用中超时自动关闭，这里用了evtimer&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$timeout_watcher &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= new &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;EvTimer&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;10.0&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;0.&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, function () use (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;) {&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;socket_close&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;stop&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;BREAK_ALL&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;br /&gt;});&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//当socket可用后，进行发送接收操作&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$write_watcher &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= new &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;EvIo&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;WRITE&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, function (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;)&lt;br /&gt;    use (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$timeout_watcher&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$e_nonblocking&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;)&lt;br /&gt;{&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//超时timer停用&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$timeout_watcher&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;stop&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//停用evio监视&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;stop&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;/p&gt;
&lt;p&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$in &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"HEAD / HTTP/1.1\r\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$in &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;.= &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"Host: google.co.uk\r\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$in &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;.= &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"Connection: Close\r\n\r\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;/p&gt;
&lt;p&gt;    if (!&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;socket_write&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$in&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;strlen&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$in&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;))) {&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;trigger_error&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"Failed writing &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$in&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt; to socket"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;E_USER_ERROR&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;br /&gt;    }&lt;/p&gt;
&lt;p&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$read_watcher &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= new &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;EvIo&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;READ&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, function (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$re&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;)&lt;br /&gt;        use (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$e_nonblocking&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;)&lt;br /&gt;    {&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//非阻塞情况下从socket读取20字节数据&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$ret &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;socket_recv&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$out&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;20&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;MSG_DONTWAIT&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;/p&gt;
&lt;p&gt;        if (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$ret&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;) {&lt;br /&gt;            echo &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$out&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;br /&gt;        } elseif (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$ret &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;=== &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;0&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;) {&lt;br /&gt;            &lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//读取完毕&lt;br /&gt;            &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;stop&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;br /&gt;            &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;socket_close&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;br /&gt;            return;&lt;br /&gt;        }&lt;br /
&gt;&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//socket通讯错误&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;if (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;in_array&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;socket_last_error&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(), &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$e_nonblocking&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;)) {&lt;br /&gt;            return;&lt;br /&gt;        }&lt;/p&gt;
&lt;p&gt;        &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;stop&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;socket_close&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;br /&gt;    });&lt;/p&gt;
&lt;p&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;run&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;br /&gt;});&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$result &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;socket_connect&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$socket&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$address&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$service_port&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;run&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;/span&gt;&lt;/span&gt;</code>
  </p>
  
  <p>
    ===========================<br />信号处理，当收到控制信号时自动启动<br /><code>&lt;span STYLE="color: #000000"&gt;&lt;span STYLE="color: #0000BB"&gt;$w &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= new &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;EvSignal&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;SIGTERM&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, function (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$watcher&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;) {&lt;br /&gt;    echo &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"SIGTERM received\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$watcher&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;stop&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;br /&gt;});&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;run&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;/span&gt;&lt;/span&gt;</code>
  </p>
  
  <p>
    ===========================<br /><code>&lt;span STYLE="color: #000000"&gt;&lt;span STYLE="color: #FF8000"&gt;//指定文件修改监视当监视文件出现变化，则触发，每8秒检查一次&lt;br /&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= new &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;EvStat&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"/var/log/messages"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;8&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, function (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;) {&lt;br /&gt;    echo &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"/var/log/messages changed\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;;&lt;/p&gt;
&lt;p&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$attr &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;attr&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;/p&gt;
&lt;p&gt;    if (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$attr&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;[&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;'nlink'&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;]) {&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;printf&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"Current size: %ld\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$attr&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;[&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;'size'&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;]);&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;printf&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"Current atime: %ld\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$attr&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;[&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;'atime'&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;]);&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;printf&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"Current mtime: %ld\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$attr&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;[&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;'mtime'&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;]);&lt;br /&gt;    } else {&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;fprintf&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;STDERR&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"`messages` file is not there!"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;stop&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;br /&gt;    }&lt;br /&gt;});&lt;/p&gt;
&lt;p&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;run&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;/span&gt;&lt;/span&gt;</code>
  </p>
  
  <p>
    ============================<br />进程状态监视<br /><code>&lt;span STYLE="color: #000000"&gt;&lt;span STYLE="color: #0000BB"&gt;$pid &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;pcntl_fork&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;/p&gt;
&lt;p&gt;if (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$pid &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;== -&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;1&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;) {&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;fprintf&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;STDERR&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"pcntl_fork failed\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;br /&gt;} elseif (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$pid&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;) {&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;= new &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;EvChild&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$pid&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;FALSE&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, function (&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$revents&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;) {&lt;br /&gt;        &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;stop&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;/p&gt;
&lt;p&gt;        &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;printf&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #DD0000"&gt;"Process %d exited with status %d\n"&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;rpid&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;, &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$w&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;-&gt;&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;rstatus&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;br /&gt;    });&lt;/p&gt;
&lt;p&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;Ev&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;::&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;run&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;();&lt;/p&gt;
&lt;p&gt;    &lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;// Protect against Zombies&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;pcntl_wait&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;$status&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;br /&gt;} else {&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #FF8000"&gt;//Forked child&lt;br /&gt;    &lt;/span&gt;&lt;span STYLE="color: #007700"&gt;exit(&lt;/span&gt;&lt;span STYLE="color: #0000BB"&gt;2&lt;/span&gt;&lt;span STYLE="color: #007700"&gt;);&lt;br /&gt;}&lt;/span&gt;&lt;/span&gt;</code>
  </p>
</div>

  </div><a class="u-url" href="/archives/161" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">徐艺洲</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">徐艺洲</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/xcl3721"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">xcl3721</span></a></li><li><a href="https://www.twitter.com/xcl3721"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">xcl3721</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>知止定静安虑得</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
