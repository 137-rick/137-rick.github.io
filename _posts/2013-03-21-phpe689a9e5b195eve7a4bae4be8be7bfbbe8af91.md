---
id: 161
title: PHP扩展ev示例翻译
date: 2013-03-21T11:10:56+08:00
author: 徐艺洲
layout: post
guid: http://www.fireidea.com/archives/161
permalink: /archives/161
categories:
  - PHP
  - 个人杂谈
tags:
  - it
---
<div id="sina_keyword_ad_area2" class="articalContent   ">
  php的libev扩展<br />提供了一些类似nodejs异步调用的方式，<br />用途很多，如文件状态监视，流阻塞等待异步<br />pecl库的，默认不安装，需要自己在pecl下弄个过来<br />php manual地址：http://www.php.net/manual/zh/ev.examples.php<br />如果不知道libev是啥可以看这个http://dirlt.com/libev.html<br />这里罗列下具体手册内的代码，只翻译了关键注释<br />刚才由于对代码没有整理，竟然被过滤掉了……不能发html pre代码的博客编辑器好凄惨</p> 
  
  <p>
    <code>&lt;span STYLE="color: #000000">&lt;span STYLE="color: #FF8000">//创建一个定时器，2秒后启动，不循环只执行一次&lt;br />&lt;/span>&lt;span STYLE="color: #0000BB">$w1 &lt;/span>&lt;span STYLE="color: #007700">= new &lt;/span>&lt;span STYLE="color: #0000BB">EvTimer&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">2&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">0&lt;/span>&lt;span STYLE="color: #007700">, function () {&lt;br />    echo &lt;/span>&lt;span STYLE="color: #DD0000">"2 seconds elapsed\n"&lt;/span>&lt;span STYLE="color: #007700">;&lt;br />});&lt;/p>
&lt;p>&lt;/span>&lt;span STYLE="color: #FF8000">//创建一个定时器，2秒后启动，1秒执行一次&lt;br />// 直到碰到指定代码停止&lt;br />&lt;/span>&lt;span STYLE="color: #0000BB">$w2 &lt;/span>&lt;span STYLE="color: #007700">= new &lt;/span>&lt;span STYLE="color: #0000BB">EvTimer&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">2&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">1&lt;/span>&lt;span STYLE="color: #007700">, function (&lt;/span>&lt;span STYLE="color: #0000BB">$w&lt;/span>&lt;span STYLE="color: #007700">) {&lt;br />    echo &lt;/span>&lt;span STYLE="color: #DD0000">"is called every second, is launched after 2 seconds\n"&lt;/span>&lt;span STYLE="color: #007700">;&lt;br />    echo &lt;/span>&lt;span STYLE="color: #DD0000">"iteration = "&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">Ev&lt;/span>&lt;span STYLE="color: #007700">::&lt;/span>&lt;span STYLE="color: #0000BB">iteration&lt;/span>&lt;span STYLE="color: #007700">(), &lt;/span>&lt;span STYLE="color: #0000BB">PHP_EOL&lt;/span>&lt;span STYLE="color: #007700">;&lt;/p>
&lt;p>    &lt;/span>&lt;span STYLE="color: #FF8000">//执行第五次停止&lt;br />    &lt;/span>&lt;span STYLE="color: #0000BB">Ev&lt;/span>&lt;span STYLE="color: #007700">::&lt;/span>&lt;span STYLE="color: #0000BB">iteration&lt;/span>&lt;span STYLE="color: #007700">() == &lt;/span>&lt;span STYLE="color: #0000BB">5 &lt;/span>&lt;span STYLE="color: #007700">and &lt;/span>&lt;span STYLE="color: #0000BB">$w&lt;/span>&lt;span STYLE="color: #007700">-&gt;&lt;/span>&lt;span STYLE="color: #0000BB">stop&lt;/span>&lt;span STYLE="color: #007700">();&lt;br />    &lt;/span>&lt;span STYLE="color: #FF8000">// Stop the watcher if further calls cause more than 10 iterations&lt;br />    &lt;/span>&lt;span STYLE="color: #0000BB">Ev&lt;/span>&lt;span STYLE="color: #007700">::&lt;/span>&lt;span STYLE="color: #0000BB">iteration&lt;/span>&lt;span STYLE="color: #007700">() &gt;= &lt;/span>&lt;span STYLE="color: #0000BB">10 &lt;/span>&lt;span STYLE="color: #007700">and &lt;/span>&lt;span STYLE="color: #0000BB">$w&lt;/span>&lt;span STYLE="color: #007700">-&gt;&lt;/span>&lt;span STYLE="color: #0000BB">stop&lt;/span>&lt;span STYLE="color: #007700">();&lt;br />});&lt;/p>
&lt;p>&lt;/span>&lt;span STYLE="color: #FF8000">//创建计时器，未激活，需要代码激活&lt;br />&lt;/span>&lt;span STYLE="color: #0000BB">$w_stopped &lt;/span>&lt;span STYLE="color: #007700">= &lt;/span>&lt;span STYLE="color: #0000BB">EvTimer&lt;/span>&lt;span STYLE="color: #007700">::&lt;/span>&lt;span STYLE="color: #0000BB">createStopped&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">10&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">5&lt;/span>&lt;span STYLE="color: #007700">, function(&lt;/span>&lt;span STYLE="color: #0000BB">$w&lt;/span>&lt;span STYLE="color: #007700">) {&lt;br />    echo &lt;/span>&lt;span STYLE="color: #DD0000">"Callback of a timer created as stopped\n"&lt;/span>&lt;span STYLE="color: #007700">;&lt;/p>
&lt;p>    &lt;/span>&lt;span STYLE="color: #FF8000">//事件产生两次后停止定时器&lt;br />    &lt;/span>&lt;span STYLE="color: #0000BB">Ev&lt;/span>&lt;span STYLE="color: #007700">::&lt;/span>&lt;span STYLE="color: #0000BB">iteration&lt;/span>&lt;span STYLE="color: #007700">() &gt;= &lt;/span>&lt;span STYLE="color: #0000BB">2 &lt;/span>&lt;span STYLE="color: #007700">and &lt;/span>&lt;span STYLE="color: #0000BB">$w&lt;/span>&lt;span STYLE="color: #007700">-&gt;&lt;/span>&lt;span STYLE="color: #0000BB">stop&lt;/span>&lt;span STYLE="color: #007700">();&lt;br />});&lt;/p>
&lt;p>&lt;/span>&lt;span STYLE="color: #FF8000">//循环直到所有都关闭&lt;br />&lt;/span>&lt;span STYLE="color: #0000BB">Ev&lt;/span>&lt;span STYLE="color: #007700">::&lt;/span>&lt;span STYLE="color: #0000BB">run&lt;/span>&lt;span STYLE="color: #007700">();&lt;/p>
&lt;p>&lt;/span>&lt;span STYLE="color: #FF8000">//启动并检查是否开始工作&lt;br />&lt;/span>&lt;span STYLE="color: #0000BB">$w_stopped&lt;/span>&lt;span STYLE="color: #007700">-&gt;&lt;/span>&lt;span STYLE="color: #0000BB">start&lt;/span>&lt;span STYLE="color: #007700">();&lt;br />echo &lt;/span>&lt;span STYLE="color: #DD0000">"Run single iteration\n"&lt;/span>&lt;span STYLE="color: #007700">;&lt;br />&lt;/span>&lt;span STYLE="color: #0000BB">Ev&lt;/span>&lt;span STYLE="color: #007700">::&lt;/span>&lt;span STYLE="color: #0000BB">run&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">Ev&lt;/span>&lt;span STYLE="color: #007700">::&lt;/span>&lt;span STYLE="color: #0000BB">RUN_ONCE&lt;/span>&lt;span STYLE="color: #007700">);&lt;/p>
&lt;p>echo &lt;/span>&lt;span STYLE="color: #DD0000">"重启定时器，并尝试继续处理相同事件，但是这次是非阻塞的方式\n"&lt;/span>&lt;span STYLE="color: #007700">;&lt;br />&lt;/span>&lt;span STYLE="color: #0000BB">$w2&lt;/span>&lt;span STYLE="color: #007700">-&gt;&lt;/span>&lt;span STYLE="color: #0000BB">again&lt;/span>&lt;span STYLE="color: #007700">();&lt;br />&lt;/span>&lt;span STYLE="color: #0000BB">Ev&lt;/span>&lt;span STYLE="color: #007700">::&lt;/span>&lt;span STYLE="color: #0000BB">run&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">Ev&lt;/span>&lt;span STYLE="color: #007700">::&lt;/span>&lt;span STYLE="color: #0000BB">RUN_NOWAIT&lt;/span>&lt;span STYLE="color: #007700">);&lt;/p>
&lt;p>&lt;/span>&lt;span STYLE="color: #0000BB">$w &lt;/span>&lt;span STYLE="color: #007700">= new &lt;/span>&lt;span STYLE="color: #0000BB">EvTimer&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">10&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">0&lt;/span>&lt;span STYLE="color: #007700">, function() {});&lt;br />echo &lt;/span>&lt;span STYLE="color: #DD0000">"阻塞方式运行\n"&lt;/span>&lt;span STYLE="color: #007700">;&lt;br />&lt;/span>&lt;span STYLE="color: #0000BB">Ev&lt;/span>&lt;span STYLE="color: #007700">::&lt;/span>&lt;span STYLE="color: #0000BB">run&lt;/span>&lt;span STYLE="color: #007700">();&lt;br />echo &lt;/span>&lt;span STYLE="color: #DD0000">"END\n"&lt;/span>&lt;span STYLE="color: #007700">;&lt;/span>&lt;/span></code>
  </p>
  
  <p>
    ========================<br /><code>&lt;span STYLE="color: #000000">&lt;span STYLE="color: #FF8000">//等待一直到STDIN准备好并可读&lt;br />&lt;/span>&lt;span STYLE="color: #0000BB">$w &lt;/span>&lt;span STYLE="color: #007700">= new &lt;/span>&lt;span STYLE="color: #0000BB">EvIo&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">STDIN&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">Ev&lt;/span>&lt;span STYLE="color: #007700">::&lt;/span>&lt;span STYLE="color: #0000BB">READ&lt;/span>&lt;span STYLE="color: #007700">, function (&lt;/span>&lt;span STYLE="color: #0000BB">$watcher&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">$revents&lt;/span>&lt;span STYLE="color: #007700">) {&lt;br />    echo &lt;/span>&lt;span STYLE="color: #DD0000">"STDIN is readable\n"&lt;/span>&lt;span STYLE="color: #007700">;&lt;br />});&lt;/p>
&lt;p>&lt;/span>&lt;span STYLE="color: #0000BB">Ev&lt;/span>&lt;span STYLE="color: #007700">::&lt;/span>&lt;span STYLE="color: #0000BB">run&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">Ev&lt;/span>&lt;span STYLE="color: #007700">::&lt;/span>&lt;span STYLE="color: #0000BB">RUN_ONCE&lt;/span>&lt;span STYLE="color: #007700">);&lt;/span>&lt;/span></code>
  </p>
  
  <p>
    ========================<br />非阻塞<br /><code>&lt;span STYLE="color: #000000">&lt;span STYLE="color: #0000BB">$e_nonblocking &lt;/span>&lt;span STYLE="color: #007700">= array (&lt;/span>&lt;span STYLE="
color: #0000BB">11&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">115&lt;/span>&lt;span STYLE="color: #007700">);&lt;/p>
&lt;p>&lt;/span> &lt;span STYLE="color: #FF8000">//获取www服务服务端口&lt;br />&lt;/span>&lt;span STYLE="color: #0000BB">$service_port &lt;/span>&lt;span STYLE="color: #007700">= &lt;/span>&lt;span STYLE="color: #0000BB">getservbyname&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #DD0000">'www'&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #DD0000">'tcp'&lt;/span>&lt;span STYLE="color: #007700">);&lt;/p>
&lt;p>&lt;/span>&lt;span STYLE="color: #FF8000">//获取域名对应ip&lt;br />&lt;/span>&lt;span STYLE="color: #0000BB">$address &lt;/span>&lt;span STYLE="color: #007700">= &lt;/span>&lt;span STYLE="color: #0000BB">gethostbyname&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #DD0000">'google.co.uk'&lt;/span>&lt;span STYLE="color: #007700">);&lt;/p>
&lt;p>&lt;/span>&lt;span STYLE="color: #FF8000">//创建socket通讯&lt;br />&lt;/span>&lt;span STYLE="color: #0000BB">$socket &lt;/span>&lt;span STYLE="color: #007700">= &lt;/span>&lt;span STYLE="color: #0000BB">socket_create&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">AF_INET&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">SOCK_STREAM&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">SOL_TCP&lt;/span>&lt;span STYLE="color: #007700">);&lt;br />if (&lt;/span>&lt;span STYLE="color: #0000BB">$socket &lt;/span>&lt;span STYLE="color: #007700">=== &lt;/span>&lt;span STYLE="color: #0000BB">FALSE&lt;/span>&lt;span STYLE="color: #007700">) {&lt;br />    echo &lt;/span>&lt;span STYLE="color: #DD0000">"socket_create() failed: reason: "&lt;br />        &lt;/span>&lt;span STYLE="color: #007700">.&lt;/span>&lt;span STYLE="color: #0000BB">socket_strerror&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">socket_last_error&lt;/span>&lt;span STYLE="color: #007700">()) . &lt;/span>&lt;span STYLE="color: #DD0000">"\n"&lt;/span>&lt;span STYLE="color: #007700">;&lt;br />}&lt;/p>
&lt;p>&lt;/span>&lt;span STYLE="color: #FF8000">//表示非阻塞方式&lt;br />&lt;/span>&lt;span STYLE="color: #0000BB">socket_set_nonblock&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">$socket&lt;/span>&lt;span STYLE="color: #007700">);&lt;/p>
&lt;p>&lt;/span>&lt;span STYLE="color: #FF8000">//如果在使用中超时自动关闭，这里用了evtimer&lt;br />&lt;/span>&lt;span STYLE="color: #0000BB">$timeout_watcher &lt;/span>&lt;span STYLE="color: #007700">= new &lt;/span>&lt;span STYLE="color: #0000BB">EvTimer&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">10.0&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">0.&lt;/span>&lt;span STYLE="color: #007700">, function () use (&lt;/span>&lt;span STYLE="color: #0000BB">$socket&lt;/span>&lt;span STYLE="color: #007700">) {&lt;br />    &lt;/span>&lt;span STYLE="color: #0000BB">socket_close&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">$socket&lt;/span>&lt;span STYLE="color: #007700">);&lt;br />    &lt;/span>&lt;span STYLE="color: #0000BB">Ev&lt;/span>&lt;span STYLE="color: #007700">::&lt;/span>&lt;span STYLE="color: #0000BB">stop&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">Ev&lt;/span>&lt;span STYLE="color: #007700">::&lt;/span>&lt;span STYLE="color: #0000BB">BREAK_ALL&lt;/span>&lt;span STYLE="color: #007700">);&lt;br />});&lt;/p>
&lt;p>&lt;/span>&lt;span STYLE="color: #FF8000">//当socket可用后，进行发送接收操作&lt;br />&lt;/span>&lt;span STYLE="color: #0000BB">$write_watcher &lt;/span>&lt;span STYLE="color: #007700">= new &lt;/span>&lt;span STYLE="color: #0000BB">EvIo&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">$socket&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">Ev&lt;/span>&lt;span STYLE="color: #007700">::&lt;/span>&lt;span STYLE="color: #0000BB">WRITE&lt;/span>&lt;span STYLE="color: #007700">, function (&lt;/span>&lt;span STYLE="color: #0000BB">$w&lt;/span>&lt;span STYLE="color: #007700">)&lt;br />    use (&lt;/span>&lt;span STYLE="color: #0000BB">$socket&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">$timeout_watcher&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">$e_nonblocking&lt;/span>&lt;span STYLE="color: #007700">)&lt;br />{&lt;br />    &lt;/span>&lt;span STYLE="color: #FF8000">//超时timer停用&lt;br />    &lt;/span>&lt;span STYLE="color: #0000BB">$timeout_watcher&lt;/span>&lt;span STYLE="color: #007700">-&gt;&lt;/span>&lt;span STYLE="color: #0000BB">stop&lt;/span>&lt;span STYLE="color: #007700">();&lt;br />    &lt;/span>&lt;span STYLE="color: #FF8000">//停用evio监视&lt;br />    &lt;/span>&lt;span STYLE="color: #0000BB">$w&lt;/span>&lt;span STYLE="color: #007700">-&gt;&lt;/span>&lt;span STYLE="color: #0000BB">stop&lt;/span>&lt;span STYLE="color: #007700">();&lt;/p>
&lt;p>    &lt;/span>&lt;span STYLE="color: #0000BB">$in &lt;/span>&lt;span STYLE="color: #007700">= &lt;/span>&lt;span STYLE="color: #DD0000">"HEAD / HTTP/1.1\r\n"&lt;/span>&lt;span STYLE="color: #007700">;&lt;br />    &lt;/span>&lt;span STYLE="color: #0000BB">$in &lt;/span>&lt;span STYLE="color: #007700">.= &lt;/span>&lt;span STYLE="color: #DD0000">"Host: google.co.uk\r\n"&lt;/span>&lt;span STYLE="color: #007700">;&lt;br />    &lt;/span>&lt;span STYLE="color: #0000BB">$in &lt;/span>&lt;span STYLE="color: #007700">.= &lt;/span>&lt;span STYLE="color: #DD0000">"Connection: Close\r\n\r\n"&lt;/span>&lt;span STYLE="color: #007700">;&lt;/p>
&lt;p>    if (!&lt;/span>&lt;span STYLE="color: #0000BB">socket_write&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">$socket&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">$in&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">strlen&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">$in&lt;/span>&lt;span STYLE="color: #007700">))) {&lt;br />        &lt;/span>&lt;span STYLE="color: #0000BB">trigger_error&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #DD0000">"Failed writing &lt;/span>&lt;span STYLE="color: #0000BB">$in&lt;/span>&lt;span STYLE="color: #DD0000"> to socket"&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">E_USER_ERROR&lt;/span>&lt;span STYLE="color: #007700">);&lt;br />    }&lt;/p>
&lt;p>    &lt;/span>&lt;span STYLE="color: #0000BB">$read_watcher &lt;/span>&lt;span STYLE="color: #007700">= new &lt;/span>&lt;span STYLE="color: #0000BB">EvIo&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">$socket&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">Ev&lt;/span>&lt;span STYLE="color: #007700">::&lt;/span>&lt;span STYLE="color: #0000BB">READ&lt;/span>&lt;span STYLE="color: #007700">, function (&lt;/span>&lt;span STYLE="color: #0000BB">$w&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">$re&lt;/span>&lt;span STYLE="color: #007700">)&lt;br />        use (&lt;/span>&lt;span STYLE="color: #0000BB">$socket&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">$e_nonblocking&lt;/span>&lt;span STYLE="color: #007700">)&lt;br />    {&lt;br />        &lt;/span>&lt;span STYLE="color: #FF8000">//非阻塞情况下从socket读取20字节数据&lt;br />        &lt;/span>&lt;span STYLE="color: #0000BB">$ret &lt;/span>&lt;span STYLE="color: #007700">= &lt;/span>&lt;span STYLE="color: #0000BB">socket_recv&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">$socket&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">$out&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">20&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">MSG_DONTWAIT&lt;/span>&lt;span STYLE="color: #007700">);&lt;/p>
&lt;p>        if (&lt;/span>&lt;span STYLE="color: #0000BB">$ret&lt;/span>&lt;span STYLE="color: #007700">) {&lt;br />            echo &lt;/span>&lt;span STYLE="color: #0000BB">$out&lt;/span>&lt;span STYLE="color: #007700">;&lt;br />        } elseif (&lt;/span>&lt;span STYLE="color: #0000BB">$ret &lt;/span>&lt;span STYLE="color: #007700">=== &lt;/span>&lt;span STYLE="color: #0000BB">0&lt;/span>&lt;span STYLE="color: #007700">) {&lt;br />            &lt;/span>&lt;span STYLE="color: #FF8000">//读取完毕&lt;br />            &lt;/span>&lt;span STYLE="color: #0000BB">$w&lt;/span>&lt;span STYLE="color: #007700">-&gt;&lt;/span>&lt;span STYLE="color: #0000BB">stop&lt;/span>&lt;span STYLE="color: #007700">();&lt;br />            &lt;/span>&lt;span STYLE="color: #0000BB">socket_close&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">$socket&lt;/span>&lt;span STYLE="color: #007700">);&lt;br />            return;&lt;br />        }&lt;br /
>&lt;br />        &lt;/span>&lt;span STYLE="color: #FF8000">//socket通讯错误&lt;br />        &lt;/span>&lt;span STYLE="color: #007700">if (&lt;/span>&lt;span STYLE="color: #0000BB">in_array&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">socket_last_error&lt;/span>&lt;span STYLE="color: #007700">(), &lt;/span>&lt;span STYLE="color: #0000BB">$e_nonblocking&lt;/span>&lt;span STYLE="color: #007700">)) {&lt;br />            return;&lt;br />        }&lt;/p>
&lt;p>        &lt;/span>&lt;span STYLE="color: #0000BB">$w&lt;/span>&lt;span STYLE="color: #007700">-&gt;&lt;/span>&lt;span STYLE="color: #0000BB">stop&lt;/span>&lt;span STYLE="color: #007700">();&lt;br />        &lt;/span>&lt;span STYLE="color: #0000BB">socket_close&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">$socket&lt;/span>&lt;span STYLE="color: #007700">);&lt;br />    });&lt;/p>
&lt;p>    &lt;/span>&lt;span STYLE="color: #0000BB">Ev&lt;/span>&lt;span STYLE="color: #007700">::&lt;/span>&lt;span STYLE="color: #0000BB">run&lt;/span>&lt;span STYLE="color: #007700">();&lt;br />});&lt;/p>
&lt;p>&lt;/span>&lt;span STYLE="color: #0000BB">$result &lt;/span>&lt;span STYLE="color: #007700">= &lt;/span>&lt;span STYLE="color: #0000BB">socket_connect&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">$socket&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">$address&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">$service_port&lt;/span>&lt;span STYLE="color: #007700">);&lt;/p>
&lt;p>&lt;/span>&lt;span STYLE="color: #0000BB">Ev&lt;/span>&lt;span STYLE="color: #007700">::&lt;/span>&lt;span STYLE="color: #0000BB">run&lt;/span>&lt;span STYLE="color: #007700">();&lt;/span>&lt;/span></code>
  </p>
  
  <p>
    ===========================<br />信号处理，当收到控制信号时自动启动<br /><code>&lt;span STYLE="color: #000000">&lt;span STYLE="color: #0000BB">$w &lt;/span>&lt;span STYLE="color: #007700">= new &lt;/span>&lt;span STYLE="color: #0000BB">EvSignal&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">SIGTERM&lt;/span>&lt;span STYLE="color: #007700">, function (&lt;/span>&lt;span STYLE="color: #0000BB">$watcher&lt;/span>&lt;span STYLE="color: #007700">) {&lt;br />    echo &lt;/span>&lt;span STYLE="color: #DD0000">"SIGTERM received\n"&lt;/span>&lt;span STYLE="color: #007700">;&lt;br />    &lt;/span>&lt;span STYLE="color: #0000BB">$watcher&lt;/span>&lt;span STYLE="color: #007700">-&gt;&lt;/span>&lt;span STYLE="color: #0000BB">stop&lt;/span>&lt;span STYLE="color: #007700">();&lt;br />});&lt;/p>
&lt;p>&lt;/span>&lt;span STYLE="color: #0000BB">Ev&lt;/span>&lt;span STYLE="color: #007700">::&lt;/span>&lt;span STYLE="color: #0000BB">run&lt;/span>&lt;span STYLE="color: #007700">();&lt;/span>&lt;/span></code>
  </p>
  
  <p>
    ===========================<br /><code>&lt;span STYLE="color: #000000">&lt;span STYLE="color: #FF8000">//指定文件修改监视当监视文件出现变化，则触发，每8秒检查一次&lt;br />&lt;/span>&lt;span STYLE="color: #0000BB">$w &lt;/span>&lt;span STYLE="color: #007700">= new &lt;/span>&lt;span STYLE="color: #0000BB">EvStat&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #DD0000">"/var/log/messages"&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">8&lt;/span>&lt;span STYLE="color: #007700">, function (&lt;/span>&lt;span STYLE="color: #0000BB">$w&lt;/span>&lt;span STYLE="color: #007700">) {&lt;br />    echo &lt;/span>&lt;span STYLE="color: #DD0000">"/var/log/messages changed\n"&lt;/span>&lt;span STYLE="color: #007700">;&lt;/p>
&lt;p>    &lt;/span>&lt;span STYLE="color: #0000BB">$attr &lt;/span>&lt;span STYLE="color: #007700">= &lt;/span>&lt;span STYLE="color: #0000BB">$w&lt;/span>&lt;span STYLE="color: #007700">-&gt;&lt;/span>&lt;span STYLE="color: #0000BB">attr&lt;/span>&lt;span STYLE="color: #007700">();&lt;/p>
&lt;p>    if (&lt;/span>&lt;span STYLE="color: #0000BB">$attr&lt;/span>&lt;span STYLE="color: #007700">[&lt;/span>&lt;span STYLE="color: #DD0000">'nlink'&lt;/span>&lt;span STYLE="color: #007700">]) {&lt;br />        &lt;/span>&lt;span STYLE="color: #0000BB">printf&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #DD0000">"Current size: %ld\n"&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">$attr&lt;/span>&lt;span STYLE="color: #007700">[&lt;/span>&lt;span STYLE="color: #DD0000">'size'&lt;/span>&lt;span STYLE="color: #007700">]);&lt;br />        &lt;/span>&lt;span STYLE="color: #0000BB">printf&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #DD0000">"Current atime: %ld\n"&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">$attr&lt;/span>&lt;span STYLE="color: #007700">[&lt;/span>&lt;span STYLE="color: #DD0000">'atime'&lt;/span>&lt;span STYLE="color: #007700">]);&lt;br />        &lt;/span>&lt;span STYLE="color: #0000BB">printf&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #DD0000">"Current mtime: %ld\n"&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">$attr&lt;/span>&lt;span STYLE="color: #007700">[&lt;/span>&lt;span STYLE="color: #DD0000">'mtime'&lt;/span>&lt;span STYLE="color: #007700">]);&lt;br />    } else {&lt;br />        &lt;/span>&lt;span STYLE="color: #0000BB">fprintf&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">STDERR&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #DD0000">"`messages` file is not there!"&lt;/span>&lt;span STYLE="color: #007700">);&lt;br />        &lt;/span>&lt;span STYLE="color: #0000BB">$w&lt;/span>&lt;span STYLE="color: #007700">-&gt;&lt;/span>&lt;span STYLE="color: #0000BB">stop&lt;/span>&lt;span STYLE="color: #007700">();&lt;br />    }&lt;br />});&lt;/p>
&lt;p>&lt;/span>&lt;span STYLE="color: #0000BB">Ev&lt;/span>&lt;span STYLE="color: #007700">::&lt;/span>&lt;span STYLE="color: #0000BB">run&lt;/span>&lt;span STYLE="color: #007700">();&lt;/span>&lt;/span></code>
  </p>
  
  <p>
    ============================<br />进程状态监视<br /><code>&lt;span STYLE="color: #000000">&lt;span STYLE="color: #0000BB">$pid &lt;/span>&lt;span STYLE="color: #007700">= &lt;/span>&lt;span STYLE="color: #0000BB">pcntl_fork&lt;/span>&lt;span STYLE="color: #007700">();&lt;/p>
&lt;p>if (&lt;/span>&lt;span STYLE="color: #0000BB">$pid &lt;/span>&lt;span STYLE="color: #007700">== -&lt;/span>&lt;span STYLE="color: #0000BB">1&lt;/span>&lt;span STYLE="color: #007700">) {&lt;br />    &lt;/span>&lt;span STYLE="color: #0000BB">fprintf&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">STDERR&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #DD0000">"pcntl_fork failed\n"&lt;/span>&lt;span STYLE="color: #007700">);&lt;br />} elseif (&lt;/span>&lt;span STYLE="color: #0000BB">$pid&lt;/span>&lt;span STYLE="color: #007700">) {&lt;br />    &lt;/span>&lt;span STYLE="color: #0000BB">$w &lt;/span>&lt;span STYLE="color: #007700">= new &lt;/span>&lt;span STYLE="color: #0000BB">EvChild&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">$pid&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">FALSE&lt;/span>&lt;span STYLE="color: #007700">, function (&lt;/span>&lt;span STYLE="color: #0000BB">$w&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">$revents&lt;/span>&lt;span STYLE="color: #007700">) {&lt;br />        &lt;/span>&lt;span STYLE="color: #0000BB">$w&lt;/span>&lt;span STYLE="color: #007700">-&gt;&lt;/span>&lt;span STYLE="color: #0000BB">stop&lt;/span>&lt;span STYLE="color: #007700">();&lt;/p>
&lt;p>        &lt;/span>&lt;span STYLE="color: #0000BB">printf&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #DD0000">"Process %d exited with status %d\n"&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">$w&lt;/span>&lt;span STYLE="color: #007700">-&gt;&lt;/span>&lt;span STYLE="color: #0000BB">rpid&lt;/span>&lt;span STYLE="color: #007700">, &lt;/span>&lt;span STYLE="color: #0000BB">$w&lt;/span>&lt;span STYLE="color: #007700">-&gt;&lt;/span>&lt;span STYLE="color: #0000BB">rstatus&lt;/span>&lt;span STYLE="color: #007700">);&lt;br />    });&lt;/p>
&lt;p>    &lt;/span>&lt;span STYLE="color: #0000BB">Ev&lt;/span>&lt;span STYLE="color: #007700">::&lt;/span>&lt;span STYLE="color: #0000BB">run&lt;/span>&lt;span STYLE="color: #007700">();&lt;/p>
&lt;p>    &lt;/span>&lt;span STYLE="color: #FF8000">// Protect against Zombies&lt;br />    &lt;/span>&lt;span STYLE="color: #0000BB">pcntl_wait&lt;/span>&lt;span STYLE="color: #007700">(&lt;/span>&lt;span STYLE="color: #0000BB">$status&lt;/span>&lt;span STYLE="color: #007700">);&lt;br />} else {&lt;br />    &lt;/span>&lt;span STYLE="color: #FF8000">//Forked child&lt;br />    &lt;/span>&lt;span STYLE="color: #007700">exit(&lt;/span>&lt;span STYLE="color: #0000BB">2&lt;/span>&lt;span STYLE="color: #007700">);&lt;br />}&lt;/span>&lt;/span></code>
  </p>